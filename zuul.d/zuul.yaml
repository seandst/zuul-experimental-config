# All components are combined in a single config while prototyping,
# but will be broken up once this stuff works

# pipelines are trigger templates used by projects
- pipeline:
    name: check-test
    manager: independent
    precedence: normal
    trigger:
      github:
        - event: pull_request
          action:
            - opened
            - changed
            - reopened
        - event: pull_request
          action: labeled
          label: 'zuul:check'
    success:
      github:
        check: success
        comment: false
        status: 'success'
    failure:
      github:
        check: failure
        comment: false
        status: 'failure'

- pipeline:
    name: check
    description: |
      Runs when the 'zuul:check-test' check is added with status 'success'
    manager: independent
    precedence: normal
    require:
      github:
        status: "oasis-zuul\\[bot\\]:check-test:success"
        open: true
        current-patchset: true
    trigger:
      # the check-test success will need to be reapplied on every
      # update to the PR, but that should happen automatically once
      # the zuul:check label is applied, or if the check-test automation
      # otherwise succeeds
      github:
        - event: pull_request
          action: status
          status: "oasis-zuul\\[bot\\]:check-test:success"
    start:
      github:
        check: in_progress
        comment: false
        status: 'pending'
    success:
      github:
        check: success
        comment: false
        merge: true
        status: 'success'
      pgsql:
    failure:
      github:
        check: failure
        comment: false
        status: 'failure'
      pgsql:

# jobs that can be run
- job:
    name: base
    # I'm pretty sure these don't exist, and docs are only
    # using them as examples, but hey, I'm curious to see
    # exactly what happens
    pre-run: copy-git-repos
    post-run: copy-logs

- job:
    name: check-test
    parent: base
    description: >
      Triggered on PR opened or labeled, used to check if a PR should be
      tested by zuul, as determined by the job run. Only reports success,
      so the check-test playbook can fail and not result in a failing
      check being added to a PR. A success result or adding the "zuul:check"
      label will allow further zuul automation to run on this pull request.
    run: playbooks/check-test/run.yml
    nodeset: rhel7

# projects map github repos to pipelines and jobs -- they glue it all together
# this is a named template, which makes it relatively easy to keep consistent
# test setups across the various oasis collections
- project-template:
    name: oasis-ansible-collection
    check-test:
      jobs:
        - check-test
      debug: true

- project:
    name: seandst/ansible_collection_system
    default-branch: master
    templates:
      - oasis-ansible-collection

# map job requirements to nodepool labels
- nodeset:
    name: rhel7
    nodes:
      - name: controller
        label: ocp-rhel7

- semaphore:
    name: semaphore-ocp4
    max: 8
